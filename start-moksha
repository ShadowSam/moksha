#!/bin/bash
# Moksha initialization script

if [ ! $VIRTUAL_ENV ]; then
    if [ ! -d tg2env ]; then
        echo "Initializing a TurboGears2 virtual environment"
        if [ ! -f tg2-bootstrap.py ]; then
            wget http://www.turbogears.org/2.0/downloads/2.0final/tg2-bootstrap.py
        fi
        python tg2-bootstrap.py --no-site-packages tg2env
        source tg2env/bin/activate

        # Hack around Shove's hard SQLAlchemy requirement :(
        easy_install -U Shove
        sed -i -e 's/SQLAlchemy==0\.4/SQLAlchemy/' tg2env/lib/python2.6/site-packages/shove-*.egg/EGG-INFO/requires.txt
        easy_install -U SQLAlchemy
        easy_install Paver

        #./pip.py install -E tg2env -r normal-reqs.txt --extra-index-url=http://www.turbogears.org/2.0/downloads/current/index
        #easy_install -i http://www.turbogears.org/2.0/downloads/current/index tg.devtools
        #pushd moksha/widgetbrowser; python setup.py develop; popd
    else
        source tg2env/bin/activate
    fi
fi

python setup.py develop

echo "Starting Moksha..."

echo "Starting the WSGI stack..."
paster serve development.ini &
echo $! >> paster.pid

echo "Starting Orbited..."
orbited &
echo $! >> orbited.pid

echo "Starting the Moksha Hub..."
moksha-hub -v &
echo $! >> hub.pid

#echo "Starting memcached..."
#memcached &
#echo $! > memcached.pid
